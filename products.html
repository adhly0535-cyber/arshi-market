<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>Arshi Market</title>

<style>
body{
  font-family: Arial;
  margin:0;
  padding-bottom:80px;
  background:#f5f5f5;
}
.country-name{
  background:#4CAF50;
  color:#fff;
  text-align:center;
  padding:8px;
  font-weight:bold;
  cursor:pointer;
}
.categories{
  display:flex;
  gap:8px;
  padding:10px;
  background:#fff;
  overflow-x:auto;
}
.categories button{
  border:none;
  background:#eee;
  padding:8px 14px;
  border-radius:20px;
  cursor:pointer;
}
.categories button.active{
  background:#4CAF50;
  color:#fff;
}
.states{
  display:none;
  gap:8px;
  padding:10px;
  background:#fff;
  overflow-x:auto;
}
.states button{
  border:none;
  background:#ddd;
  padding:6px 14px;
  border-radius:20px;
  cursor:pointer;
}
.states button.active{
  background:#4CAF50;
  color:#fff;
}
.products{
  padding:10px;
  display:grid;
  grid-template-columns: repeat(2,1fr);
  gap:10px;
}
.product-card{
  background:#fff;
  padding:8px;
  border-radius:10px;
}
.product-card b{
  color:#4CAF50;
}
.chat-btn{
  margin-top:6px;
  width:100%;
  background:#4CAF50;
  color:#fff;
  border:none;
  padding:6px;
  border-radius:6px;
  cursor:pointer;
}
.bottom-nav{
  position:fixed;
  bottom:0;
  width:100%;
  background:#fff;
  display:flex;
  justify-content:space-around;
  padding:8px 0;
  border-top:1px solid #ccc;
}
.add-product-fab{
  position:fixed;
  bottom:90px;
  left:20px;
  background:#4CAF50;
  color:#fff;
  border:none;
  width:55px;
  height:55px;
  border-radius:50%;
  font-size:28px;
}
</style>
</head>

<body>

<div class="country-name" id="countryName"></div>

<div class="categories">
  <button onclick="selectCategory(this,'Ø³ÙŠØ§Ø±Ø§Øª')">ğŸš— Ø³ÙŠØ§Ø±Ø§Øª</button>
  <button onclick="selectCategory(this,'Ø¹Ù‚Ø§Ø±Ø§Øª')">ğŸ¢ Ø¹Ù‚Ø§Ø±Ø§Øª</button>
  <button onclick="selectCategory(this,'ÙˆØ¸Ø§Ø¦Ù')">ğŸ§‘â€ğŸ’¼ ÙˆØ¸Ø§Ø¦Ù</button>
  <button onclick="selectCategory(this,'Ù‡ÙˆØ§ØªÙ + Ø­ÙˆØ§Ø³ÙŠØ¨')">ğŸ“±ğŸ’» Ù‡ÙˆØ§ØªÙ + Ø­ÙˆØ§Ø³ÙŠØ¨</button>
</div>

<div class="states" id="statesBox"></div>
<div class="products" id="products"></div>

<div class="bottom-nav">
  <button onclick="go('products.html')">ğŸ <br>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
  <button onclick="go('inbox.html')">ğŸ’¬<br>Ø§Ù„Ø´Ø§Øª</button>
  <button onclick="go('account.html')">ğŸ‘¤<br>Ø§Ù„Ø­Ø³Ø§Ø¨</button>
  <button onclick="go('settings.html')">âš™ï¸<br>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
</div>

<button class="add-product-fab" onclick="goAddProduct()">+</button>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, collection, onSnapshot,
  doc, getDoc, setDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getAuth } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyD3hAvhSDs-lX7ORCOR0DODT3l_S_gJA2o",
  authDomain: "arshi-market.firebaseapp.com",
  projectId: "arshi-market",
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

const country = localStorage.getItem("country");
if(!country) location.href="country.html";
document.getElementById("countryName").innerText = "ğŸ“ Ø§Ù„Ø¯ÙˆÙ„Ø©: " + country;

/* âœ… ÙƒÙ„ Ø§Ù„ÙˆÙ„Ø§ÙŠØ§Øª Ù…ÙˆØ¬ÙˆØ¯Ø© */

const statesByCountry = {  
  "Ø§Ù„Ø³ÙˆØ¯Ø§Ù†":[  
    "Ø§Ù„Ø®Ø±Ø·ÙˆÙ…","Ø§Ù„Ø¬Ø²ÙŠØ±Ø©","Ù†Ù‡Ø± Ø§Ù„Ù†ÙŠÙ„","Ø§Ù„Ø¨Ø­Ø± Ø§Ù„Ø£Ø­Ù…Ø±","ÙƒØ³Ù„Ø§","Ø§Ù„Ù‚Ø¶Ø§Ø±Ù",  
    "Ø³Ù†Ø§Ø±","Ø§Ù„Ù†ÙŠÙ„ Ø§Ù„Ø£Ø¨ÙŠØ¶","Ø´Ù…Ø§Ù„ ÙƒØ±Ø¯ÙØ§Ù†","Ø¬Ù†ÙˆØ¨ ÙƒØ±Ø¯ÙØ§Ù†",  
    "Ø´Ù…Ø§Ù„ Ø¯Ø§Ø±ÙÙˆØ±","Ø¬Ù†ÙˆØ¨ Ø¯Ø§Ø±ÙÙˆØ±","ØºØ±Ø¨ Ø¯Ø§Ø±ÙÙˆØ±"  
  ],  
  "Ù…ØµØ±":[  
    "Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©","Ø§Ù„Ø¬ÙŠØ²Ø©","Ø§Ù„Ø¥Ø³ÙƒÙ†Ø¯Ø±ÙŠØ©","Ø§Ù„Ø¯Ù‚Ù‡Ù„ÙŠØ©","Ø§Ù„Ø´Ø±Ù‚ÙŠØ©","Ø§Ù„Ù‚Ù„ÙŠÙˆØ¨ÙŠØ©",  
    "ÙƒÙØ± Ø§Ù„Ø´ÙŠØ®","Ø§Ù„ØºØ±Ø¨ÙŠØ©","Ø§Ù„Ù…Ù†ÙˆÙÙŠØ©","Ø§Ù„Ø¨Ø­ÙŠØ±Ø©","Ø¯Ù…ÙŠØ§Ø·","Ø¨ÙˆØ±Ø³Ø¹ÙŠØ¯",  
    "Ø§Ù„Ø¥Ø³Ù…Ø§Ø¹ÙŠÙ„ÙŠØ©","Ø§Ù„Ø³ÙˆÙŠØ³","Ø§Ù„ÙÙŠÙˆÙ…","Ø§Ù„Ù…Ù†ÙŠØ§","Ø£Ø³ÙŠÙˆØ·","Ø³ÙˆÙ‡Ø§Ø¬",  
    "Ù‚Ù†Ø§","Ø§Ù„Ø£Ù‚ØµØ±","Ø£Ø³ÙˆØ§Ù†","Ù…Ø·Ø±ÙˆØ­","Ø§Ù„ÙˆØ§Ø¯ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯","Ø´Ù…Ø§Ù„ Ø³ÙŠÙ†Ø§Ø¡","Ø¬Ù†ÙˆØ¨ Ø³ÙŠÙ†Ø§Ø¡"  
  ]  
};  


const statesBox=document.getElementById("statesBox");
let currentState="";
let currentCategory="";

/* Ø¥Ù†Ø´Ø§Ø¡ Ø£Ø²Ø±Ø§Ø± Ø§Ù„ÙˆÙ„Ø§ÙŠØ§Øª */
(statesByCountry[country]||[]).forEach(s=>{
  const b=document.createElement("button");
  b.textContent=s;
  b.onclick=()=>{
    document.querySelectorAll(".states button").forEach(x=>x.classList.remove("active"));
    b.classList.add("active");
    currentState=s;
    showProducts();
  };
  statesBox.appendChild(b);
});

let allProducts=[];
onSnapshot(collection(db,"products"),snap=>{
  allProducts=snap.docs.map(d=>({id:d.id,...d.data()}));
  showProducts();
});

window.selectCategory=(btn,cat)=>{
  document.querySelectorAll(".categories button").forEach(b=>b.classList.remove("active"));
  btn.classList.add("active");
  currentCategory=cat;
  statesBox.style.display="flex";
  showProducts();
};

/* âœ… Ù‡Ù†Ø§ Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ */
function showProducts(){
  const box=document.getElementById("products");
  box.innerHTML="";

  allProducts.filter(p=>
    p.country===country &&
    (!currentCategory || p.category===currentCategory) &&
    (!currentState || p.state===currentState)
  ).forEach(p=>{
    box.innerHTML+=`
    <div class="product-card">
      <p><b>${p.title}</b></p>
      <p>${p.price}</p>
      <button class="chat-btn"
        onclick="startChat('${p.id}','${p.ownerId}','${p.title}')">
        ğŸ’¬ Ù…Ø±Ø§Ø³Ù„Ø©
      </button>
    </div>`;
  });
}

/* ğŸ”¥ Ø´Ø§Øª Ø­Ù‚ÙŠÙ‚ÙŠ */
window.startChat = async (productId, sellerId, title)=>{
  const user = auth.currentUser;
  if(!user){
    alert("Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹");
    location.href="index.html";
    return;
  }
  if(user.uid===sellerId){
    alert("Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ù…Ø±Ø§Ø³Ù„Ø© Ù†ÙØ³Ùƒ");
    return;
  }

  const chatId = productId+"_"+user.uid+"_"+sellerId;
  const ref = doc(db,"chats",chatId);
  const snap = await getDoc(ref);

  if(!snap.exists()){
    await setDoc(ref,{
      productId,
      title,
      users:[user.uid,sellerId],
      createdAt:Date.now()
    });
  }

  location.href="chat.html?chatId="+chatId;
};
</script>

<script>
function go(p){location.href=p;}
function goAddProduct(){location.href="add-product.html";}
</script>

</body>
  </html>
