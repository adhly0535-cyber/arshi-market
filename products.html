<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>Arshi Market</title>

<style>
body{
  font-family: Arial;
  margin:0;
  padding-bottom:80px;
  background:#f5f5f5;
}
.country-name{
  background:#4CAF50;
  color:#fff;
  text-align:center;
  padding:8px;
  font-weight:bold;
}
.categories, .states{
  display:flex;
  gap:8px;
  padding:10px;
  background:#fff;
  overflow-x:auto;
}
.categories button, .states button{
  border:none;
  background:#eee;
  padding:8px 14px;
  border-radius:20px;
  cursor:pointer;
  white-space:nowrap;
}
.categories button.active,
.states button.active{
  background:#4CAF50;
  color:#fff;
}
.products{
  padding:10px;
  display:grid;
  grid-template-columns:repeat(2,1fr);
  gap:10px;
}
.product-card{
  background:#fff;
  padding:8px;
  border-radius:10px;
}
.product-images{
  display:flex;
  gap:4px;
}
.product-images img{
  width:32%;
  height:90px;
  object-fit:cover;
  border-radius:6px;
  cursor:pointer;
}
.price{
  color:#4CAF50;
  font-weight:bold;
}
.product-info{
  font-size:12px;
  color:#555;
}
.whatsapp-number{
  font-size:12px;
  margin-top:4px;
  color:#333;
  word-break:break-all;
}
.whatsapp-btn{
  width:100%;
  margin-top:6px;
  background:#25D366;
  color:#fff;
  border:none;
  padding:6px;
  border-radius:6px;
  cursor:pointer;
}
.bottom-nav{
  position:fixed;
  bottom:0;
  width:100%;
  background:#fff;
  display:flex;
  justify-content:space-around;
  padding:6px 0;
  border-top:1px solid #ccc;
}
.bottom-nav button{
  background:none;
  border:none;
  font-size:13px;
}
.add-product-fab{
  position:fixed;
  bottom:90px;
  left:20px;
  background:#4CAF50;
  color:#fff;
  border:none;
  width:55px;
  height:55px;
  border-radius:50%;
  font-size:28px;
}
.image-viewer{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.85);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:9999;
}
.image-viewer img{
  max-width:95%;
  max-height:95%;
}
</style>
</head>

<body>

<div id="countryName" class="country-name"></div>

<div class="categories">
  <button onclick="selectCategory(this,'Ø³ÙŠØ§Ø±Ø§Øª')">ğŸš— Ø³ÙŠØ§Ø±Ø§Øª</button>
  <button onclick="selectCategory(this,'Ø¹Ù‚Ø§Ø±Ø§Øª')">ğŸ¢ Ø¹Ù‚Ø§Ø±Ø§Øª</button>
  <button onclick="selectCategory(this,'ÙˆØ¸Ø§Ø¦Ù')">ğŸ§‘â€ğŸ’¼ ÙˆØ¸Ø§Ø¦Ù</button>
  <button onclick="selectCategory(this,'Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ§Øª')">ğŸ“± Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ§Øª</button>
  <button onclick="selectCategory(this,'ØªØ¬Ø§Ø±Ø©')">ğŸ›’ ØªØ¬Ø§Ø±Ø©</button>
</div>

<div class="states" id="statesBox" style="display:none;"></div>
<div class="products" id="products"></div>

<button class="add-product-fab" onclick="goAddProduct()">+</button>

<div class="bottom-nav">
  <button onclick="go('products.html')">ğŸ <br>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
  <button onclick="go('account.html')">ğŸ‘¤<br>Ø§Ù„Ø­Ø³Ø§Ø¨</button>
  <button onclick="go('settings.html')">âš™ï¸<br>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
</div>

<div class="image-viewer" id="imageViewer" onclick="this.style.display='none'">
  <img id="viewerImg">
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, onSnapshot, doc, getDoc, query, where } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyD3hAvhSDs-lX7ORCOR0DODT3l_S_gJA2o",
  authDomain: "arshi-market.firebaseapp.com",
  projectId: "arshi-market",
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let country = "";
let currentCategory = "";
let currentState = "";
let unsubscribe = null;

const statesByCountry = {
  "Ø§Ù„Ø³ÙˆØ¯Ø§Ù†":[
    "Ø§Ù„Ø®Ø±Ø·ÙˆÙ…","Ø§Ù„Ø¬Ø²ÙŠØ±Ø©","Ù†Ù‡Ø± Ø§Ù„Ù†ÙŠÙ„","Ø§Ù„Ø¨Ø­Ø± Ø§Ù„Ø£Ø­Ù…Ø±","ÙƒØ³Ù„Ø§","Ø§Ù„Ù‚Ø¶Ø§Ø±Ù",
    "Ø³Ù†Ø§Ø±","Ø§Ù„Ù†ÙŠÙ„ Ø§Ù„Ø£Ø¨ÙŠØ¶","Ø´Ù…Ø§Ù„ ÙƒØ±Ø¯ÙØ§Ù†","Ø¬Ù†ÙˆØ¨ ÙƒØ±Ø¯ÙØ§Ù†","ØºØ±Ø¨ ÙƒØ±Ø¯ÙØ§Ù†",
    "Ø´Ù…Ø§Ù„ Ø¯Ø§Ø±ÙÙˆØ±","Ø¬Ù†ÙˆØ¨ Ø¯Ø§Ø±ÙÙˆØ±","ØºØ±Ø¨ Ø¯Ø§Ø±ÙÙˆØ±","ÙˆØ³Ø· Ø¯Ø§Ø±ÙÙˆØ±","Ø´Ø±Ù‚ Ø¯Ø§Ø±ÙÙˆØ±",
    "Ø§Ù„Ø´Ù…Ø§Ù„ÙŠØ©","Ø§Ù„Ù†ÙŠÙ„ Ø§Ù„Ø£Ø²Ø±Ù‚"
  ]
};

onAuthStateChanged(auth, async(user)=>{
  if(!user){
    console.log("Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„");
    return;
  }

  const snap = await getDoc(doc(db,"users",user.uid));
  if(!snap.exists()) return;

  country = snap.data().country;
  document.getElementById("countryName").innerText = "ğŸ“ Ø§Ù„Ø¯ÙˆÙ„Ø©: " + country;
});

window.selectCategory=(btn,cat)=>{
  document.querySelectorAll(".categories button").forEach(b=>b.classList.remove("active"));
  btn.classList.add("active");
  currentCategory = cat;
  loadStates();
};

function loadStates(){
  const statesBox = document.getElementById("statesBox");
  statesBox.style.display="flex";
  statesBox.innerHTML="";
  (statesByCountry[country] || []).forEach((s,i)=>{
    const b=document.createElement("button");
    b.textContent=s;
    b.onclick=()=>{
      document.querySelectorAll(".states button").forEach(x=>x.classList.remove("active"));
      b.classList.add("active");
      currentState=s;
      loadProducts();
    };
    if(i===0){ currentState=s; b.classList.add("active"); }
    statesBox.appendChild(b);
  });
  loadProducts();
}

function loadProducts(){
  if(!country || !currentCategory || !currentState) return;

  const box=document.getElementById("products");
  box.innerHTML="â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...";
  if(unsubscribe) unsubscribe();

  const q=query(
    collection(db,"products"),
    where("country","==",country),
    where("category","==",currentCategory),
    where("city","==",currentState)
  );

  unsubscribe = onSnapshot(q,snap=>{
    box.innerHTML="";

    if(snap.empty){
      box.innerHTML="ğŸ˜¢ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹";
      return;
    }

    snap.forEach(docSnap=>{
      const p=docSnap.data();
      const cleanNumber = (p.whatsapp || "").replace(/\D/g,"");
      const message = encodeURIComponent(
        "Ù…Ø±Ø­Ø¨Ù‹Ø§ ğŸ‘‹\nØ£Ø±ØºØ¨ ÙÙŠ Ø§Ù„Ø§Ø³ØªÙØ³Ø§Ø± Ø¹Ù† Ø§Ù„Ù…Ù†ØªØ¬:\n" + p.title
      );
      const whatsappLink = `https://wa.me/${cleanNumber}?text=${message}`;

      box.innerHTML+=`
      <div class="product-card">
        <div class="product-images">
          ${(p.images||[]).slice(0,3).map(img=>`<img src="${img}" onclick="viewImage('${img}')">`).join("")}
        </div>
        <b>${p.title}</b>
        <div class="price">${p.price}</div>
        <div class="product-info">
          ğŸ“‚ ${p.category}<br>
          ğŸ“ ${p.city}
          ${p.tradeType ? `<br>ğŸ›’ ${p.tradeType}` : ""}
        </div>
        <div class="whatsapp-number">
          ğŸ“ ${p.whatsapp || "ØºÙŠØ± Ù…ØªÙˆÙØ±"}
        </div>
        ${p.whatsapp ? `<button class="whatsapp-btn" onclick="window.open('${whatsappLink}','_blank')">ğŸ’¬ ØªÙˆØ§ØµÙ„ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨</button>` : ""}
      </div>`;
    });
  });
}

window.viewImage=(src)=>{
  document.getElementById("viewerImg").src=src;
  document.getElementById("imageViewer").style.display="flex";
};

window.go=p=>location.href=p;
window.goAddProduct=()=>location.href="add-product.html";

</script>
</body>
</html>
