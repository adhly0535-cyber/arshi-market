<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>Arshi Market</title>

<style>
body{
  font-family: Arial;
  margin:0;
  padding-bottom:80px;
  background:#f5f5f5;
}
.country-name{
  background:#4CAF50;
  color:#fff;
  text-align:center;
  padding:8px;
  font-weight:bold;
  cursor:pointer;
}
.categories{
  display:flex;
  gap:8px;
  padding:10px;
  background:#fff;
  overflow-x:auto;
}
.categories button{
  border:none;
  background:#eee;
  padding:8px 14px;
  border-radius:20px;
  cursor:pointer;
}
.categories button.active{
  background:#4CAF50;
  color:#fff;
}
.states{
  display:none;
}
.products{
  padding:10px;
  display:grid;
  grid-template-columns: repeat(2,1fr);
  gap:10px;
}
.product-card{
  background:#fff;
  padding:8px;
  border-radius:10px;
}
.product-images{
  display:flex;
  gap:4px;
  margin-bottom:6px;
}
.product-images img{
  width:32%;
  height:90px;
  object-fit:cover;
  border-radius:6px;
  cursor:pointer;
}
.product-card b{color:#4CAF50;}
.more-btn{
  width:100%;
  margin-top:6px;
  background:#eee;
  border:none;
  padding:6px;
  border-radius:6px;
  cursor:pointer;
}
.more-info{
  display:none;
  background:#fafafa;
  padding:6px;
  border-radius:6px;
  margin-top:6px;
  font-size:13px;
}
.chat-btn{
  margin-top:6px;
  width:100%;
  background:#4CAF50;
  color:#fff;
  border:none;
  padding:6px;
  border-radius:6px;
  cursor:pointer;
}
.bottom-nav{
  position:fixed;
  bottom:0;
  width:100%;
  background:#fff;
  display:flex;
  justify-content:space-around;
  padding:6px 0;
  border-top:1px solid #ccc;
}
.bottom-nav button{
  background:none;
  border:none;
  font-size:13px;
  cursor:pointer;
}
.add-product-fab{
  position:fixed;
  bottom:90px;
  left:20px;
  background:#4CAF50;
  color:#fff;
  border:none;
  width:55px;
  height:55px;
  border-radius:50%;
  font-size:28px;
}
.image-viewer{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.85);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:9999;
}
.image-viewer img{
  max-width:95%;
  max-height:95%;
  border-radius:10px;
}
</style>
</head>

<body>

<div class="country-name" id="countryName"></div>

<div class="categories">
  <button onclick="selectCategory(this,'Ø³ÙŠØ§Ø±Ø§Øª')">ğŸš— Ø³ÙŠØ§Ø±Ø§Øª</button>
  <button onclick="selectCategory(this,'Ø¹Ù‚Ø§Ø±Ø§Øª')">ğŸ¢ Ø¹Ù‚Ø§Ø±Ø§Øª</button>
  <button onclick="selectCategory(this,'ÙˆØ¸Ø§Ø¦Ù')">ğŸ§‘â€ğŸ’¼ ÙˆØ¸Ø§Ø¦Ù</button>
  <button onclick="selectCategory(this,'Ù‡ÙˆØ§ØªÙ + Ø­ÙˆØ§Ø³ÙŠØ¨')">ğŸ“±ğŸ’» Ù‡ÙˆØ§ØªÙ + Ø­ÙˆØ§Ø³ÙŠØ¨</button>
</div>

<div class="products" id="products"></div>

<button class="add-product-fab" onclick="goAddProduct()">+</button>

<div class="image-viewer" id="imageViewer" onclick="this.style.display='none'">
  <img id="viewerImg">
</div>

<div class="bottom-nav">
  <button onclick="go('home.html')">ğŸ <br>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
  <button onclick="go('chats.html')">ğŸ’¬<br>Ø§Ù„Ø´Ø§Øª</button>
  <button onclick="go('profile.html')">ğŸ‘¤<br>Ø§Ù„Ø­Ø³Ø§Ø¨</button>
  <button onclick="go('settings.html')">âš™ï¸<br>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, onSnapshot, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const app = initializeApp({
  apiKey:"AIzaSyD3hAvhSDs-lX7ORCOR0DODT3l_S_gJA2o",
  authDomain:"arshi-market.firebaseapp.com",
  projectId:"arshi-market",
});
const db=getFirestore(app);
const auth=getAuth(app);

let country=localStorage.getItem("country");
let currentCategory=localStorage.getItem("selectedCategory")||"";

onAuthStateChanged(auth,async user=>{
  if(!user){location.href="index.html";return;}
  if(!country){
    const s=await getDoc(doc(db,"users",user.uid));
    if(s.exists()){
      country=s.data().country;
      localStorage.setItem("country",country);
    }
  }
  document.getElementById("countryName").innerText="ğŸ“ Ø§Ù„Ø¯ÙˆÙ„Ø©: "+country;
});

let allProducts=[];
onSnapshot(collection(db,"products"),snap=>{
  allProducts=snap.docs.map(d=>({id:d.id,...d.data()}));
  showProducts();
});

window.selectCategory=(btn,cat)=>{
  document.querySelectorAll(".categories button").forEach(b=>b.classList.remove("active"));
  btn.classList.add("active");
  currentCategory=cat;
  localStorage.setItem("selectedCategory",cat);
  showProducts();
};

function showProducts(){
  const box=document.getElementById("products");
  box.innerHTML="";
  allProducts
  .filter(p=>p.country===country && (!currentCategory||p.category===currentCategory))
  .forEach(p=>{
    const extra=getExtraDetails(p);
    const hasMore=extra.length>0;

    box.innerHTML+=`
    <div class="product-card">
      ${p.images?.length?`
      <div class="product-images">
        ${p.images.slice(0,3).map(i=>`<img src="${i}" onclick="viewImage('${i}')">`).join("")}
      </div>`:""}

      <p><b>${p.title}</b></p>
      <p>ğŸ’° ${p.price||"â€”"}</p>
      <p>ğŸ“‚ ${p.category||"â€”"}</p>
      <p>â± ${p.createdAt || "Ø­Ø¯ÙŠØ«Ù‹Ø§"}</p>

      ${hasMore?`
      <button class="more-btn" onclick="toggleMore(this)">â• Ù…Ø²ÙŠØ¯</button>
      <div class="more-info">${extra.join("")}</div>`:""}

      <button class="chat-btn" onclick="startChat('${p.id}','${p.userId}')">ğŸ’¬ Ù…Ø±Ø§Ø³Ù„Ø©</button>
    </div>`;
  });
}

function getExtraDetails(p){
  const d=[];
  if(p.category==="Ø³ÙŠØ§Ø±Ø§Øª"){
    if(p.model)d.push(`ğŸš— Ù…ÙˆØ¯ÙŠÙ„: ${p.model}<br>`);
    if(p.year)d.push(`ğŸ“… Ø³Ù†Ø©: ${p.year}<br>`);
  }
  if(p.category==="Ø¹Ù‚Ø§Ø±Ø§Øª"){
    if(p.type)d.push(`ğŸ¢ Ù†ÙˆØ¹: ${p.type}<br>`);
    if(p.rooms)d.push(`ğŸ› ØºØ±Ù: ${p.rooms}<br>`);
  }
  if(p.category==="ÙˆØ¸Ø§Ø¦Ù"){
    if(p.company)d.push(`ğŸ¢ Ø´Ø±ÙƒØ©: ${p.company}<br>`);
    if(p.jobType)d.push(`â± Ø¯ÙˆØ§Ù…: ${p.jobType}<br>`);
  }
  if(p.category==="Ù‡ÙˆØ§ØªÙ + Ø­ÙˆØ§Ø³ÙŠØ¨"){
    if(p.brand)d.push(`ğŸ“± Ø§Ù„Ù†ÙˆØ¹: ${p.brand}<br>`);
    if(p.storage)d.push(`ğŸ’¾ Ø³Ø¹Ø©: ${p.storage}<br>`);
  }
  if(p.description)d.push(`ğŸ“ ${p.description}`);
  return d;
}

window.toggleMore=btn=>{
  const box=btn.nextElementSibling;
  const open=box.style.display==="block";
  box.style.display=open?"none":"block";
  btn.innerText=open?"â• Ù…Ø²ÙŠØ¯":"â– Ø¥Ø®ÙØ§Ø¡";
};

window.startChat=(pid,uid)=>{
  const me=auth.currentUser;
  if(!me)return;
  location.href="chat.html?chatId="+[pid,me.uid,uid].sort().join("_");
};
window.viewImage=s=>{viewerImg.src=s;imageViewer.style.display="flex";}
window.go=p=>location.href=p;
window.goAddProduct=()=>location.href="add-product.html";
</script>

</body>
  </html>
