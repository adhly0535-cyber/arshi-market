<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>المراسلة</title>

<style>
body{
  margin:0;
  font-family: Arial;
  background:#f2f2f2;
  direction: rtl;
  display:flex;
  flex-direction:column;
  height:100vh;
}

/* ===== رأس الشات ===== */
.header{
  background:#4CAF50;
  color:#fff;
  padding:10px;
  display:flex;
  align-items:center;
  gap:10px;
}
.header img{
  width:40px;
  height:40px;
  border-radius:50%;
  object-fit:cover;
}
.header .info{
  display:flex;
  flex-direction:column;
}
.header .name{
  font-weight:bold;
  font-size:15px;
}
.header .status{
  font-size:12px;
  opacity:0.9;
}

/* ===== الرسائل ===== */
.chat-box{
  flex:1;
  padding:10px;
  overflow-y:auto;
}
.message{
  max-width:70%;
  margin-bottom:10px;
  padding:8px 12px;
  border-radius:15px;
  font-size:14px;
  word-wrap:break-word;
}
.me{
  background:#4CAF50;
  color:#fff;
  margin-left:auto;
}
.other{
  background:#fff;
  color:#000;
  margin-right:auto;
}

/* ===== الإدخال ===== */
.input-bar{
  display:flex;
  padding:8px;
  background:#fff;
  border-top:1px solid #ccc;
}
.input-bar input{
  flex:1;
  padding:10px;
  border-radius:20px;
  border:1px solid #ccc;
}
.input-bar button{
  background:#4CAF50;
  color:#fff;
  border:none;
  padding:10px 16px;
  border-radius:20px;
  margin-right:6px;
  cursor:pointer;
}
</style>
</head>

<body>

<!-- رأس الشات -->
<div class="header">
  <img id="otherImg" src="https://via.placeholder.com/150">
  <div class="info">
    <div class="name" id="otherName">جاري التحميل...</div>
    <div class="status">متصل</div>
  </div>
</div>

<div class="chat-box" id="chatBox"></div>

<div class="input-bar">
  <input id="msgInput" placeholder="اكتب رسالتك...">
  <button id="sendBtn">إرسال</button>
</div>

<script type="module">
import { initializeApp } from
"https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";

import { getAuth, onAuthStateChanged } from
"https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

import {
  getFirestore, collection, addDoc,
  query, orderBy, onSnapshot,
  doc, updateDoc, getDoc
} from
"https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* Firebase */
const firebaseConfig = {
  apiKey: "AIzaSyD3hAvhSDs-lX7ORCOR0DODT3l_S_gJA2o",
  authDomain: "arshi-market.firebaseapp.com",
  projectId: "arshi-market"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* عناصر */
const chatBox = document.getElementById("chatBox");
const otherName = document.getElementById("otherName");
const otherImg = document.getElementById("otherImg");

/* chatId */
const chatId = new URLSearchParams(location.search).get("chatId");

let currentUser;
let otherUserId;

/* تحقق تسجيل الدخول */
onAuthStateChanged(auth, async user=>{
  if(!user){
    location.href="index.html";
    return;
  }
  currentUser = user;

  if(!chatId){
    otherName.textContent="محادثة غير صالحة";
    return;
  }

  /* جلب بيانات الشات */
  const chatSnap = await getDoc(doc(db,"chats",chatId));
  if(!chatSnap.exists()){
    otherName.textContent="المحادثة غير موجودة";
    return;
  }

  const chatData = chatSnap.data();
  otherUserId = chatData.users.find(u=>u!==currentUser.uid);

  /* جلب بيانات المستخدم الآخر */
  const userSnap = await getDoc(doc(db,"users",otherUserId));
  if(userSnap.exists()){
    const u = userSnap.data();
    otherName.textContent = u.name || "مستخدم";
    otherImg.src = u.photo || otherImg.src;
  }else{
    otherName.textContent = "مستخدم";
  }

  loadMessages();
});

/* تحميل الرسائل */
function loadMessages(){
  const q = query(
    collection(db,"chats",chatId,"messages"),
    orderBy("time")
  );

  onSnapshot(q, snap=>{
    chatBox.innerHTML="";

    snap.forEach(d=>{
      const m = d.data();
      const div = document.createElement("div");
      div.className =
        "message " + (m.uid===currentUser.uid ? "me" : "other");
      div.textContent = m.text;
      chatBox.appendChild(div);
    });

    chatBox.scrollTop = chatBox.scrollHeight;
  });
}

/* إرسال */
document.getElementById("sendBtn").onclick = async ()=>{
  const text = msgInput.value.trim();
  if(!text) return;

  await addDoc(
    collection(db,"chats",chatId,"messages"),
    {
      text,
      uid: currentUser.uid,
      time: Date.now()
    }
  );

  await updateDoc(
    doc(db,"chats",chatId),
    {
      lastMessage:text,
      lastTime:Date.now()
    }
  );

  msgInput.value="";
};
</script>

</body>
</html>
