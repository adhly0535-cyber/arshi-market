<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>الشات</title>

<style>
body{
  margin:0;
  font-family:Arial;
  background:#f2f2f2;
  direction:rtl;
  height:100vh;
  display:flex;
}

/* ===== القائمة ===== */
#chatList{
  width:320px;
  background:#fff;
  border-left:1px solid #ddd;
  overflow-y:auto;
}
.chat{
  padding:10px;
  display:flex;
  gap:10px;
  border-bottom:1px solid #eee;
  cursor:pointer;
}
.chat img{
  width:45px;
  height:45px;
  border-radius:50%;
}
.chat .name{font-weight:bold}

/* ===== الشات ===== */
#chatArea{
  flex:1;
  display:none;
  flex-direction:column;
}
.header{
  background:#4CAF50;
  color:#fff;
  padding:10px;
  display:flex;
  align-items:center;
  gap:10px;
}
.header img{
  width:40px;
  height:40px;
  border-radius:50%;
}
.chat-box{
  flex:1;
  padding:10px;
  overflow-y:auto;
}
.message{
  max-width:70%;
  margin-bottom:8px;
  padding:8px 12px;
  border-radius:15px;
}
.me{background:#4CAF50;color:#fff;margin-left:auto}
.other{background:#fff}

.input-bar{
  display:flex;
  padding:8px;
  background:#fff;
}
input{
  flex:1;
  padding:10px;
  border-radius:20px;
  border:1px solid #ccc;
}
button{
  background:#4CAF50;
  color:#fff;
  border:none;
  padding:10px 16px;
  border-radius:20px;
  cursor:pointer;
}
.backBtn{
  background:none;
  border:none;
  color:#fff;
  font-size:18px;
  cursor:pointer;
}
.last-seen{
  font-size:12px;
  opacity:.8;
}
</style>
</head>

<body>

<!-- قائمة المحادثات -->
<div id="chatList"></div>

<!-- الشات -->
<div id="chatArea">
  <div class="header">
    <button class="backBtn" onclick="location.href='products.html'">⬅</button>
    <img id="otherImg">
    <div>
      <div id="otherName"></div>
      <div id="lastSeen" class="last-seen"></div>
    </div>
  </div>

  <div class="chat-box" id="chatBox"></div>

  <div class="input-bar">
    <input id="msgInput" placeholder="اكتب رسالة">
    <button id="sendBtn">إرسال</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth,onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  getFirestore,collection,query,where,onSnapshot,
  addDoc,orderBy,doc,getDoc,updateDoc,serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig={
  apiKey:"AIzaSyD3hAvhSDs-lX7ORCOR0DODT3l_S_gJA2o",
  authDomain:"arshi-market.firebaseapp.com",
  projectId:"arshi-market"
};

const app=initializeApp(firebaseConfig);
const auth=getAuth(app);
const db=getFirestore(app);

const chatList=document.getElementById("chatList");
const chatArea=document.getElementById("chatArea");
const chatBox=document.getElementById("chatBox");
const otherName=document.getElementById("otherName");
const otherImg=document.getElementById("otherImg");
const lastSeen=document.getElementById("lastSeen");
const msgInput=document.getElementById("msgInput");
const sendBtn=document.getElementById("sendBtn");

let currentUser;
let currentChatId;
let unsubscribeMessages=null;

onAuthStateChanged(auth,async user=>{
  if(!user){ location.href="index.html"; return; }
  currentUser=user;

  // تحديث آخر ظهور
  await updateDoc(doc(db,"users",user.uid),{
    online:true,
    lastSeen:serverTimestamp()
  });

  loadChats();
});

window.addEventListener("beforeunload",()=>{
  if(currentUser){
    updateDoc(doc(db,"users",currentUser.uid),{
      online:false,
      lastSeen:serverTimestamp()
    });
  }
});

/* تحميل المحادثات */
function loadChats(){
  const q=query(
    collection(db,"chats"),
    where("users","array-contains",currentUser.uid)
  );

  onSnapshot(q,async snap=>{
    chatList.innerHTML="";
    snap.forEach(async d=>{
      const chat=d.data();
      const otherId=chat.users.find(u=>u!==currentUser.uid);
      if(!otherId) return;

      const uSnap=await getDoc(doc(db,"users",otherId));
      if(!uSnap.exists()) return;

      const u=uSnap.data();
      const div=document.createElement("div");
      div.className="chat";
      div.innerHTML=`
        <img src="${u.photo||'https://via.placeholder.com/100'}">
        <div>
          <div class="name">${u.name}</div>
          <div style="font-size:13px;color:#666">${chat.lastMessage||""}</div>
        </div>
      `;
      div.onclick=()=>openChat(d.id,u);
      chatList.appendChild(div);
    });
  });
}

/* فتح محادثة */
function openChat(chatId,user){
  currentChatId=chatId;
  chatArea.style.display="flex";
  otherName.textContent=user.name;
  otherImg.src=user.photo||"https://via.placeholder.com/100";
  lastSeen.textContent = user.online ? "متصل الآن" : "غير متصل";

  if(unsubscribeMessages) unsubscribeMessages();

  const q=query(
    collection(db,"chats",chatId,"messages"),
    orderBy("time")
  );

  unsubscribeMessages=onSnapshot(q,snap=>{
    chatBox.innerHTML="";
    snap.forEach(d=>{
      const m=d.data();

      // تعليم الرسائل كمقروءة
      if(m.uid!==currentUser.uid && !m.seen){
        updateDoc(d.ref,{ seen:true });
      }

      const div=document.createElement("div");
      div.className="message "+(m.uid===currentUser.uid?"me":"other");
      div.textContent = m.text + (m.uid===currentUser.uid && m.seen ? " ✓✓" : "");
      chatBox.appendChild(div);
    });
    chatBox.scrollTop=chatBox.scrollHeight;
  });
}

/* إرسال رسالة */
sendBtn.onclick=async()=>{
  if(!currentChatId) return;
  const text=msgInput.value.trim();
  if(!text) return;

  await addDoc(
    collection(db,"chats",currentChatId,"messages"),
    {
      text,
      uid:currentUser.uid,
      time:serverTimestamp(),
      seen:false
    }
  );

  await updateDoc(
    doc(db,"chats",currentChatId),
    {
      lastMessage:text,
      lastTime:serverTimestamp()
    }
  );

  msgInput.value="";
};
</script>

</body>
</html>
