<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>إضافة منتج</title>

<style>
body{
  font-family: Arial;
  background:#f5f5f5;
  padding:20px;
}
input, select, button{
  width:100%;
  padding:10px;
  margin:8px 0;
  font-size:16px;
}
.section{
  display:none;
  background:#fff;
  padding:10px;
  border-radius:6px;
}
button{
  background:#4CAF50;
  color:#fff;
  border:none;
}
</style>
</head>

<body>

<h3>إضافة منتج</h3>

<form id="productForm">

  <input id="name" placeholder="اسم المنتج">
  <input id="price" type="number" placeholder="السعر">

  <select id="category">
    <option value="">اختر التصنيف</option>
    <option value="house">منزل</option>
    <option value="car">سيارة</option>
    <option value="phone">هاتف</option>
  </select>

  <div id="houseFields" class="section">
    <input id="rooms" type="number" placeholder="عدد الغرف">
    <input id="area" type="number" placeholder="المساحة">
  </div>

  <div id="carFields" class="section">
    <input id="model" placeholder="الموديل">
    <input id="year" type="number" placeholder="سنة الصنع">
  </div>

  <div id="phoneFields" class="section">
    <input id="brand" placeholder="الشركة">
    <input id="storage" type="number" placeholder="الذاكرة">
  </div>

  <button type="submit">نشر المنتج</button>
</form>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getFirestore, addDoc, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "API_KEY",
  authDomain: "PROJECT_ID.firebaseapp.com",
  projectId: "PROJECT_ID",
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let user = null;

// ✅ فقط نتحقق بدون أي تحويل
onAuthStateChanged(auth, (u)=>{
  user = u;
});

const category = document.getElementById("category");
const sections = {
  house: document.getElementById("houseFields"),
  car: document.getElementById("carFields"),
  phone: document.getElementById("phoneFields")
};

category.onchange = ()=>{
  Object.values(sections).forEach(s=>s.style.display="none");
  if(sections[category.value]){
    sections[category.value].style.display="block";
  }
};

document.getElementById("productForm").onsubmit = async (e)=>{
  e.preventDefault();

  // ⛔ منع النشر فقط (بدون تحويل)
  if(!user){
    alert("❌ يجب تسجيل الدخول قبل النشر");
    return;
  }

  const name = document.getElementById("name").value.trim();
  const price = +document.getElementById("price").value;
  const cat = category.value;

  if(!name || price<=0 || !cat){
    alert("❌ املأ اسم المنتج والسعر والتصنيف");
    return;
  }

  let extra = {};

  if(cat==="car"){
    const model = document.getElementById("model").value.trim();
    const year = +document.getElementById("year").value;
    if(!model || year<=0){
      alert("❌ املأ بيانات السيارة");
      return;
    }
    extra = {model,year};
  }

  if(cat==="phone"){
    const brand = document.getElementById("brand").value.trim();
    const storage = +document.getElementById("storage").value;
    if(!brand || storage<=0){
      alert("❌ املأ بيانات الهاتف");
      return;
    }
    extra = {brand,storage};
  }

  if(cat==="house"){
    const rooms = +document.getElementById("rooms").value;
    const area = +document.getElementById("area").value;
    if(rooms<=0 || area<=0){
      alert("❌ املأ بيانات المنزل");
      return;
    }
    extra = {rooms,area};
  }

  await addDoc(collection(db,"products"),{
    name,
    price,
    category:cat,
    country: localStorage.getItem("country") || "",
    ...extra,
    userId:user.uid,
    createdAt:serverTimestamp()
  });

  alert("✅ تم النشر");
  location.href="products.html";
};
</script>

</body>
</html>
