<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬</title>

<style>
body{
  font-family:Arial;
  background:#f5f5f5;
  padding:10px;
}
input, textarea, button, select{
  width:100%;
  margin:6px 0;
  padding:10px;
  font-size:14px;
}
button{
  background:#4CAF50;
  color:#fff;
  border:none;
  border-radius:6px;
}
button:disabled{
  opacity:0.6;
}
</style>
</head>

<body>

<h3 id="pageTitle"></h3>

<form id="productForm">

  <input id="title" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†" required>
  <input id="price" placeholder="Ø§Ù„Ø³Ø¹Ø±" required>

  <select id="stateInput" required>
    <option value="">Ø§Ù„Ø­Ø§Ù„Ø©</option>
    <option value="Ø¬Ø¯ÙŠØ¯">Ø¬Ø¯ÙŠØ¯</option>
    <option value="Ù…Ø³ØªØ¹Ù…Ù„">Ù…Ø³ØªØ¹Ù…Ù„</option>
  </select>

  <input type="file" id="imagesInput" multiple accept="image/*">
  <small>Ø§Ø®ØªØ± Ù…Ù† 1 Ø¥Ù„Ù‰ 5 ØµÙˆØ±</small>

  <div id="extraFields"></div>

  <textarea id="desc" placeholder="Ø§Ù„ÙˆØµÙ" required></textarea>

  <button type="submit" id="publishBtn">ğŸ“¤ Ù†Ø´Ø± Ø§Ù„Ù…Ù†ØªØ¬</button>
</form>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

/* Firebase */
const firebaseConfig = {
  apiKey: "AIzaSyD3hAvhSDs-lX7ORCOR0DODT3l_S_gJA2o",
  authDomain: "arshi-market.firebaseapp.com",
  projectId: "arshi-market",
  storageBucket: "arshi-market.appspot.com",
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const storage = getStorage(app);

/* Ø¹Ù†Ø§ØµØ± */
const form = document.getElementById("productForm");
const publishBtn = document.getElementById("publishBtn");

const titleInput = document.getElementById("title");
const priceInput = document.getElementById("price");
const descInput  = document.getElementById("desc");
const stateInput = document.getElementById("stateInput");
const imagesInput = document.getElementById("imagesInput");

/* Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… */
let currentUser = null;
publishBtn.disabled = true;

onAuthStateChanged(auth, user=>{
  if(user){
    currentUser = user;
    publishBtn.disabled = false;
  }else{
    currentUser = null;
    publishBtn.disabled = true;
    alert("âŒ ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹");
  }
});

/* Ø§Ù„ØªØµÙ†ÙŠÙ + Ø§Ù„Ø¯ÙˆÙ„Ø© */
const params = new URLSearchParams(window.location.search);
const category = params.get("cat");
const country = localStorage.getItem("country");

document.getElementById("pageTitle").innerText = "Ø¥Ø¶Ø§ÙØ© " + category;

/* Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø­Ø³Ø¨ Ø§Ù„ØªØµÙ†ÙŠÙ */
const extra = document.getElementById("extraFields");

if(category === "Ø¨ÙŠÙˆØª"){
  extra.innerHTML = `
    <input id="rooms" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„ØºØ±Ù">
    <input id="area" placeholder="Ø§Ù„Ù…Ø³Ø§Ø­Ø©">
  `;
}
if(category === "Ø³ÙŠØ§Ø±Ø§Øª"){
  extra.innerHTML = `
    <input id="model" placeholder="Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„">
    <input id="year" placeholder="Ø³Ù†Ø© Ø§Ù„ØµÙ†Ø¹">
  `;
}
if(category === "Ù‡ÙˆØ§ØªÙ"){
  extra.innerHTML = `
    <input id="brand" placeholder="Ø§Ù„Ø´Ø±ÙƒØ©">
    <input id="phoneStorage" placeholder="Ø§Ù„Ù…Ø³Ø§Ø­Ø©">
  `;
}

/* Ø§Ù„Ù†Ø´Ø± */
form.addEventListener("submit", async (e) => {
  e.preventDefault();

  if(!currentUser){
    alert("âŒ ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„");
    return;
  }

  if(!country){
    alert("âŒ Ø§Ø®ØªØ± Ø§Ù„Ø¯ÙˆÙ„Ø©");
    return;
  }

  publishBtn.disabled = true;
  publishBtn.innerText = "â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù†Ø´Ø±...";

  try {
    const imageUrls = [];

    if(imagesInput.files.length > 0){
      if(imagesInput.files.length > 5){
        alert("âŒ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 5 ØµÙˆØ±");
        throw new Error("ØµÙˆØ± ÙƒØ«ÙŠØ±Ø©");
      }

      for(const file of imagesInput.files){
        const imgRef = ref(
          storage,
          `products/${currentUser.uid}/${Date.now()}_${file.name}`
        );
        await uploadBytes(imgRef, file);
        const url = await getDownloadURL(imgRef);
        imageUrls.push(url);
      }
    }

    await addDoc(collection(db, "products"), {
      title: titleInput.value,
      price: priceInput.value,
      desc: descInput.value,
      state: stateInput.value,
      category,
      country,
      rooms: document.getElementById("rooms")?.value || "",
      area: document.getElementById("area")?.value || "",
      model: document.getElementById("model")?.value || "",
      year: document.getElementById("year")?.value || "",
      brand: document.getElementById("brand")?.value || "",
      phoneStorage: document.getElementById("phoneStorage")?.value || "",
      images: imageUrls,
      userId: currentUser.uid,
      createdAt: serverTimestamp()
    });

    alert("âœ… ØªÙ… Ù†Ø´Ø± Ø§Ù„Ù…Ù†ØªØ¬");
    window.location.href = "products.html";

  } catch(err){
    console.error(err);
    alert("âŒ ÙØ´Ù„ Ø§Ù„Ù†Ø´Ø±");
    publishBtn.disabled = false;
    publishBtn.innerText = "ğŸ“¤ Ù†Ø´Ø± Ø§Ù„Ù…Ù†ØªØ¬";
  }
});
</script>

</body>
</html>
