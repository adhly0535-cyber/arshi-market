<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬</title>

<style>
body{
  font-family:Arial;
  background:#f5f5f5;
  padding:10px;
}
input, textarea, button, select{
  width:100%;
  margin:6px 0;
  padding:10px;
  font-size:14px;
}
button{
  background:#4CAF50;
  color:#fff;
  border:none;
  border-radius:6px;
}
</style>
</head>

<body>

<h3 id="title"></h3>

<form id="productForm">

  <input id="mainTitle" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†" required>
  <input id="price" placeholder="Ø§Ù„Ø³Ø¹Ø±" required>

  <!-- Ø­Ù‚ÙˆÙ„ Ø®Ø§ØµØ© -->
  <div id="extraFields"></div>

  <textarea id="desc" placeholder="Ø§Ù„ÙˆØµÙ"></textarea>

  <button type="submit">ğŸ“¤ Ù†Ø´Ø± Ø§Ù„Ù…Ù†ØªØ¬</button>
</form>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

/* Firebase */
const firebaseConfig = {
  apiKey: "AIzaSyD3hAvhSDs-lX7ORCOR0DODT3l_S_gJA2o",
  authDomain: "arshi-market.firebaseapp.com",
  projectId: "arshi-market",
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

/* Ø§Ù„ØªØµÙ†ÙŠÙ */
const params = new URLSearchParams(window.location.search);
const category = params.get('cat');
const country = localStorage.getItem('country');

document.getElementById('title').innerText = 'Ø¥Ø¶Ø§ÙØ© ' + category;

/* Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø­Ø³Ø¨ Ø§Ù„ØªØµÙ†ÙŠÙ */
const extra = document.getElementById('extraFields');

if(category === 'Ø¨ÙŠÙˆØª'){
  extra.innerHTML = `
    <input id="rooms" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„ØºØ±Ù">
    <input id="area" placeholder="Ø§Ù„Ù…Ø³Ø§Ø­Ø© (Ù…ØªØ±)">
  `;
}
if(category === 'Ø³ÙŠØ§Ø±Ø§Øª'){
  extra.innerHTML = `
    <input id="model" placeholder="Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„">
    <input id="year" placeholder="Ø³Ù†Ø© Ø§Ù„ØµÙ†Ø¹">
  `;
}
if(category === 'Ù‡ÙˆØ§ØªÙ'){
  extra.innerHTML = `
    <input id="brand" placeholder="Ø§Ù„Ø´Ø±ÙƒØ©">
    <input id="storage" placeholder="Ø§Ù„Ù…Ø³Ø§Ø­Ø©">
  `;
}

/* Ø§Ù„Ù†Ø´Ø± */
const form = document.getElementById('productForm');

onAuthStateChanged(auth, user=>{
  if(!user){
    alert('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„');
    return;
  }

  form.onsubmit = async (e)=>{
    e.preventDefault();

    await addDoc(collection(db,'products'),{
      title: mainTitle.value,
      price: price.value,
      desc: desc.value,
      category,
      country,
      rooms: rooms?.value || '',
      area: area?.value || '',
      model: model?.value || '',
      year: year?.value || '',
      brand: brand?.value || '',
      storage: storage?.value || '',
      userName: user.displayName,
      userImg: user.photoURL,
      createdAt: serverTimestamp()
    });

    // ğŸ”¥ Ø¨Ø¹Ø¯ Ø§Ù„Ù†Ø´Ø±
    window.location.href='products.html';
  }
});
</script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, addDoc, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyD3hAvhSDs-lX7ORCOR0DODT3l_S_gJA2o",
  authDomain: "arshi-market.firebaseapp.com",
  projectId: "arshi-market",
  storageBucket: "arshi-market.appspot.com",
  messagingSenderId: "930764899868",
  appId: "1:930764899868:web:06795817be84f0a68a01d9"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

let currentUser = null;
onAuthStateChanged(auth, u => currentUser = u);

document.getElementById("publishBtn").onclick = async () => {

  const title = document.getElementById("title").value.trim();
  const price = document.getElementById("price").value.trim();
  const desc  = document.getElementById("desc").value.trim();
  const state = document.getElementById("stateInput").value;
  const imagesInput = document.getElementById("imagesInput");

  if(!currentUser){
    alert("âŒ ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„");
    return;
  }

  if(!title || !price || !desc || !state){
    alert("âŒ ÙƒÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù…Ø·Ù„ÙˆØ¨Ø©");
    return;
  }

  if(imagesInput.files.length < 1 || imagesInput.files.length > 5){
    alert("âŒ Ø§Ø®ØªØ± Ù…Ù† 1 Ø¥Ù„Ù‰ 5 ØµÙˆØ±");
    return;
  }

  const country = localStorage.getItem("country");
  if(!country){
    alert("âŒ Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¯ÙˆÙ„Ø©");
    return;
  }

  const images = [];
  for(const file of imagesInput.files){
    const refImg = ref(storage, `products/${currentUser.uid}/${Date.now()}_${file.name}`);
    await uploadBytes(refImg, file);
    images.push(await getDownloadURL(refImg));
  }

  await addDoc(collection(db,"products"),{
    title, price, desc, state, country,
    images,
    userId: currentUser.uid,
    createdAt: serverTimestamp()
  });

  alert("âœ… ØªÙ… Ù†Ø´Ø± Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­");
  window.location.href = "products.html";
};
</script>
</body>
</html>

