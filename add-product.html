<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬</title>

<style>
body{
  font-family:Arial;
  background:#f5f5f5;
  margin:0;
  padding:10px;
}
h2{text-align:center}
form{
  background:#fff;
  padding:15px;
  border-radius:10px;
}
input, select, textarea, button{
  width:100%;
  padding:10px;
  margin-bottom:10px;
  border-radius:8px;
  border:1px solid #ccc;
}
.hidden{display:none}
button{
  background:#4CAF50;
  color:#fff;
  border:none;
  font-size:16px;
}
</style>
</head>

<body>

<h2>â• Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬</h2>

<form id="productForm">

  <input id="title" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ / Ø§Ù„Ø¹Ù†ÙˆØ§Ù†" required>
  <input id="price" placeholder="Ø§Ù„Ø³Ø¹Ø±" required>

  <!-- ğŸŒ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¯ÙˆÙ„Ø© -->
  <select id="countrySelect" required>
    <option>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¯ÙˆÙ„...</option>
  </select>

  <!-- ğŸ“ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙˆÙ„Ø§ÙŠØ© -->
  <select id="stateSelect" required>
    <option>Ø§Ø®ØªØ± Ø§Ù„Ø¯ÙˆÙ„Ø© Ø£ÙˆÙ„Ø§Ù‹</option>
  </select>

  <div id="normalFields">
    <select id="condition">
      <option value="">Ø§Ù„Ø­Ø§Ù„Ø©</option>
      <option>Ø¬Ø¯ÙŠØ¯</option>
      <option>Ù…Ø³ØªØ¹Ù…Ù„</option>
    </select>
    <input id="defects" placeholder="Ø§Ù„Ø¹ÙŠÙˆØ¨ (Ø¥Ù† ÙˆØ¬Ø¯Øª)">
  </div>

  <div id="houseFields" class="hidden">
    <input id="area" placeholder="Ø§Ù„Ù…Ù†Ø·Ù‚Ø©">
    <input id="landType" placeholder="Ù†ÙˆØ¹ Ø§Ù„Ø£Ø±Ø¶ (Ø³ÙƒÙ†ÙŠ / ØªØ¬Ø§Ø±ÙŠ)">
    <select id="built">
      <option>Ù…Ø¨Ù†ÙŠ Ø¬Ø§Ù‡Ø²</option>
      <option>Ø£Ø±Ø¶ ÙÙ‚Ø·</option>
    </select>
    <select id="deal">
      <option>Ø¨ÙŠØ¹</option>
      <option>Ø¥ÙŠØ¬Ø§Ø±</option>
    </select>
  </div>

  <textarea id="desc" placeholder="ÙˆØµÙ Ø§Ù„Ù…Ù†ØªØ¬ (Ø³Ø·Ø±ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)" required></textarea>

  <button type="submit">Ù†Ø´Ø± Ø§Ù„Ù…Ù†ØªØ¬</button>
</form>

<!-- ğŸ”¥ Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, addDoc, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase */
const firebaseConfig = {
  apiKey: "AIzaSyD3hAvhSDs-lX7ORCOR0DODT3l_S_gJA2o",
  authDomain: "arshi-market.firebaseapp.com",
  projectId: "arshi-market",
  storageBucket: "arshi-market.firebasestorage.app",
  messagingSenderId: "930764899868",
  appId: "1:930764899868:web:06795817be84f0a68a01d9",
  measurementId: "G-CCR0B650WG"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* ===== Ø¬Ù„Ø¨ Ø§Ù„Ø¯ÙˆÙ„ ===== */
const countrySelect = document.getElementById("countrySelect");
const stateSelect   = document.getElementById("stateSelect");

fetch("https://restcountries.com/v3.1/all")
.then(res => res.json())
.then(data => {
  countrySelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¯ÙˆÙ„Ø©</option>';
  data
    .sort((a,b)=>a.name.common.localeCompare(b.name.common))
    .forEach(c=>{
      const opt=document.createElement("option");
      opt.value=c.name.common;
      opt.textContent=c.name.common;
      countrySelect.appendChild(opt);
    });
});

/* ===== Ø¬Ù„Ø¨ Ø§Ù„ÙˆÙ„Ø§ÙŠØ§Øª ===== */
countrySelect.addEventListener("change", ()=>{
  const country = countrySelect.value;
  stateSelect.innerHTML = "<option>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙˆÙ„Ø§ÙŠØ§Øª...</option>";

  fetch("https://countriesnow.space/api/v0.1/countries/states",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({ country })
  })
  .then(res=>res.json())
  .then(data=>{
    stateSelect.innerHTML="";
    if(!data.data || !data.data.states.length){
      stateSelect.innerHTML="<option>Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆÙ„Ø§ÙŠØ§Øª</option>";
      return;
    }
    data.data.states.forEach(s=>{
      const opt=document.createElement("option");
      opt.value=s.name;
      opt.textContent=s.name;
      stateSelect.appendChild(opt);
    });
  });
});

/* ===== Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØµÙ†ÙŠÙ ===== */
const params = new URLSearchParams(window.location.search);
const category = params.get('cat');

if(category === 'Ø¨ÙŠÙˆØª'){
  houseFields.classList.remove('hidden');
  normalFields.classList.add('hidden');
}

/* ===== Ø§Ù„Ù†Ø´Ø± ===== */
productForm.onsubmit = async function(e){
  e.preventDefault();

  const user = auth.currentUser;
  if(!user){
    alert('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹');
    return;
  }

  let product = {
    title: title.value,
    price: price.value,
    desc: desc.value,
    category,
    country: countrySelect.value,
    state: stateSelect.value,
    userId: user.uid,
    userName: user.displayName,
    userImg: user.photoURL,
    createdAt: serverTimestamp(),
    images:['https://source.unsplash.com/300x200/?product']
  };

  if(category === 'Ø¨ÙŠÙˆØª'){
    product.area = area.value;
    product.landType = landType.value;
    product.built = built.value;
    product.deal = deal.value;
  }else{
    product.condition = condition.value;
    product.defects = defects.value;
  }

  try{
    await addDoc(collection(db,"products"),product);
    alert('âœ… ØªÙ… Ù†Ø´Ø± Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­');
    window.location.href='products.html';
  }catch(err){
    alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù†Ø´Ø±');
    console.log(err);
  }
};
</script>

</body>
</html>
