<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª</title>

<style>
body{
  margin:0;
  font-family: Arial;
  background:#f2f2f2;
  direction: rtl;
}
.header{
  background:#4CAF50;
  color:#fff;
  padding:12px;
  text-align:center;
  font-weight:bold;
}
.chat-list{
  padding:10px;
}
.chat-item{
  background:#fff;
  padding:12px;
  border-radius:10px;
  margin-bottom:10px;
  cursor:pointer;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.chat-item:hover{
  background:#f9f9f9;
}
.chat-info{
  display:flex;
  flex-direction:column;
}
.chat-title{
  font-weight:bold;
  margin-bottom:4px;
}
.chat-last{
  font-size:13px;
  color:#666;
}
.empty{
  text-align:center;
  color:#777;
  margin-top:40px;
}
</style>
</head>

<body>

<div class="header">ğŸ’¬ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª</div>

<div class="chat-list" id="chatList">
  <div class="empty">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
</div>

<script type="module">
import { initializeApp } from
"https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";

import { getAuth, onAuthStateChanged } from
"https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

import {
  getFirestore,
  collection,
  query,
  where,
  onSnapshot
} from
"https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* Firebase */
const firebaseConfig = {
  apiKey: "AIzaSyD3hAvhSDs-lX7ORCOR0DODT3l_S_gJA2o",
  authDomain: "arshi-market.firebaseapp.com",
  projectId: "arshi-market"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const chatList = document.getElementById("chatList");

/* ØªØ­Ù‚Ù‚ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ */
onAuthStateChanged(auth, user=>{
  if(!user){
    // Ø¨Ø¯ÙˆÙ† Ø£ÙŠ Ø±Ø³Ø§Ù„Ø© Ù…Ø²Ø¹Ø¬Ø©
    chatList.innerHTML =
      `<div class="empty">ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª</div>`;
    return;
  }
  loadChats(user.uid);
});

/* ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª */
function loadChats(uid){
  const q = query(
    collection(db,"chats"),
    where("users","array-contains",uid)
  );

  onSnapshot(q, snap=>{
    chatList.innerHTML = "";

    if(snap.empty){
      chatList.innerHTML =
        `<div class="empty">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø¨Ø¹Ø¯</div>`;
      return;
    }

    snap.forEach(doc=>{
      const chat = doc.data();

      const div = document.createElement("div");
      div.className="chat-item";
      div.onclick = ()=>{
        // ÙØªØ­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© ÙÙ‚Ø·
        location.href = `chat.html?chatId=${doc.id}`;
      };

      div.innerHTML = `
        <div class="chat-info">
          <div class="chat-title">
            ${chat.title || "Ù…Ø­Ø§Ø¯Ø«Ø©"}
          </div>
          <div class="chat-last">
            Ø§Ø¶ØºØ· Ù„ÙØªØ­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
          </div>
        </div>
        â¡ï¸
      `;

      chatList.appendChild(div);
    });
  }, error=>{
    chatList.innerHTML =
      `<div class="empty">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª</div>`;
  });
}
</script>

</body>
</html>
